language: nix
sudo: required
os:
- linux
env:
  matrix:
    - TEST_FILE=aiohttp
    - TEST_FILE=awscli_and_requests
    - TEST_FILE=connexion
    - TEST_FILE=empy
    - TEST_FILE=flake8
    - TEST_FILE=flake8_include_default_overrides
    - TEST_FILE=flake8_mercurial
    - TEST_FILE=flit
    - TEST_FILE=ldap
    - TEST_FILE=lektor
    - TEST_FILE=pillow
    - TEST_FILE=rss2email
    - TEST_FILE=scipy
    - TEST_FILE=tornado
install:
- sudo mount -o remount,exec,size=4G,mode=755 /run/user || true
- nix-env -iA nixpkgs.nix-prefetch-git nixpkgs.nix-prefetch-hg
script:
- nix-shell --command 'python -m unittest integrationtests/test_${TEST_FILE}.py'
stages:
- build
jobs:
  include:
  - stage: build
    os: linux
    env:
      - TEST_FILE=none
    script:
    - nix build
  - stage: build
    os: linux
    env:
      - TEST_FILE=none
    script:
      - nix-shell --command 'pytest unittests/ --cov=src/'
    after_success:
      - nix-shell -p 'python3.pkgs.codecov' --command 'codecov'
